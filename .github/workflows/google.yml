name: Build and Deploy to GKE

on:
  push:
    branches: [ "main" ]

env:
  PUBLIC_REPO: europe-central2-docker.pkg.dev/docker-396214/gitlab-k8s
  IMAGE_TAG: ${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}
  CONTEXT: "github-learn/gcloud-kubectl-helm/"
  DOCKERFILE: "Dockerfile"
  IMAGE: "gcloud-kubectl-helm"

jobs:
   build:
    runs-on: self-hosted

    steps:
      #- uses: int128/kaniko-action@v1
      - uses: aevea/action-kaniko@master
      - name: build
        run: |-
          /kaniko/executor
          --context "${CONTEXT}"
          --dockerfile "${DOCKERFILE}"
          --destination "$PUBLIC_REPO/$IMAGE:$IMAGE_TAG"
          --destination "$PUBLIC_REPO/$IMAGE:latest"
        
        # with:
        #   build_file: "${DOCKERFILE}"
        #   registry: "$PUBLIC_REPO"
        #   image: "$PUBLIC_REPO/$IMAGE:$IMAGE_TAG"
